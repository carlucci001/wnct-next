rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function getUserRole() {
      return getUserData().role;
    }

    // Admin-level roles (full access)
    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['admin', 'business-owner'];
    }

    // ============================================
    // TENANT HELPER FUNCTIONS
    // ============================================

    // Check if user owns a tenant
    function isTenantOwner(tenantId) {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/tenants/$(tenantId)).data.ownerId == request.auth.uid;
    }

    // Check if tenant is active or in trial
    function isTenantActive(tenantId) {
      let tenant = get(/databases/$(database)/documents/tenants/$(tenantId)).data;
      return tenant.status in ['active', 'trial'];
    }

    // Check if user belongs to a tenant (via user.tenantId field)
    function belongsToTenant(tenantId) {
      return isAuthenticated() && getUserData().tenantId == tenantId;
    }

    // Check if user can access tenant data (owner or member)
    function canAccessTenant(tenantId) {
      return isTenantOwner(tenantId) || belongsToTenant(tenantId) || isAdmin();
    }

    // Editorial leadership (can publish any article, manage team)
    function isEditorialLead() {
      return isAuthenticated() && getUserRole() in ['admin', 'business-owner', 'editor-in-chief'];
    }

    // Can edit/publish any article
    function isEditor() {
      return isAuthenticated() && getUserRole() in ['admin', 'business-owner', 'editor-in-chief', 'editor'];
    }

    // Can write and publish own articles
    function isJournalist() {
      return isAuthenticated() && getUserRole() in ['admin', 'business-owner', 'editor-in-chief', 'editor', 'journalist'];
    }

    // Can write articles (may need approval)
    function isWriter() {
      return isAuthenticated() && getUserRole() in ['admin', 'business-owner', 'editor-in-chief', 'editor', 'journalist', 'contributor'];
    }

    // Can moderate comments
    function isModerator() {
      return isAuthenticated() && getUserRole() in ['admin', 'business-owner', 'editor-in-chief', 'editor', 'community-moderator'];
    }

    // ============================================
    // ARTICLES
    // ============================================
    match /articles/{articleId} {
      // Anyone can read published articles
      // Editors can read all articles (including drafts)
      // Writers can read their own drafts
      allow read: if resource.data.status == 'published'
                  || isEditor()
                  || (isWriter() && resource.data.author == request.auth.token.email);

      // Writers can create articles
      allow create: if isWriter();

      // Writers can edit own articles
      // Editors can edit any article
      allow update: if isEditor()
                    || (isWriter() && resource.data.author == request.auth.token.email);

      // Editors can delete any article
      // Writers can delete their own drafts only
      allow delete: if isEditor()
                    || (isWriter() && resource.data.author == request.auth.token.email && resource.data.status == 'draft');
    }

    match /blogPosts/{postId} {
      // Anyone can read published posts
      allow read: if resource.data.status == 'published' || isEditor();

      // Writers and Editors can create/update
      allow create: if isWriter();
      allow update: if isEditor() || (isWriter() && resource.data.authorId == request.auth.uid);
      allow delete: if isEditor();
    }

    // ============================================
    // USERS
    // ============================================
    match /users/{userId} {
      // Users can read their own doc
      // Editorial leads and admins can read all users
      allow read: if isAuthenticated() && (request.auth.uid == userId || isEditorialLead());

      // Users can create their own doc on registration
      // Admins can create new user docs
      allow create: if isAuthenticated() && (request.auth.uid == userId || isAdmin());

      // Users can update their own profile (but not role/status)
      // Admins can update any user
      // Editorial leads can assign writer roles
      allow update: if isAuthenticated() && (
        (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'status']))
        || isAdmin()
        || (isEditorialLead() && request.resource.data.role in ['contributor', 'journalist', 'editor', 'reader'])
      );

      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // ============================================
    // SETTINGS (site configuration)
    // ============================================
    match /settings/{document=**} {
      // Everyone can read settings (needed for theme, etc.)
      allow read: if true;

      // Only admins can write settings
      allow write: if isAdmin();
    }

    match /componentSettings/{document=**} {
      // Everyone can read component settings (blog config, etc)
      allow read: if true;
      // Only admins can write
      allow write: if isAdmin();
    }

    // ============================================
    // COMMUNITY (directory, events, etc.)
    // ============================================
    match /community/{document=**} {
      // Anyone can read community content
      allow read: if true;

      // Moderators and writers can create/update
      allow create, update: if isModerator() || isWriter();

      // Only editors can delete
      allow delete: if isEditor();
    }

    // ============================================
    // ADS / BANNERS
    // ============================================
    match /advertising/{adId} {
      // Anyone can read active ads
      allow read: if resource.data.status == 'active' 
                  || isAdmin() 
                  || (isAuthenticated() && resource.data.clientId == request.auth.uid);

      // Clients can create their own campaigns
      allow create: if isAuthenticated() && (isAdmin() || request.resource.data.clientId == request.auth.uid);

      // Support atomic increments for impressions/clicks and admin/client updates
      allow update: if (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['impressions', 'clicks']))
                    || isAdmin()
                    || (isAuthenticated() && resource.data.clientId == request.auth.uid);

      allow delete: if isAdmin();
    }

    match /ads/{document=**} {
      // Legacy - anyone can read ads
      allow read: if true;

      // Only ad managers and admins can write
      allow write: if isAuthenticated() && getUserRole() in ['admin', 'business-owner', 'ad-manager'];
    }

    // ============================================
    // COMMENTS
    // ============================================
    match /comments/{commentId} {
      // Anyone can read approved comments
      // Moderators can read all comments
      allow read: if resource.data.status == 'approved' || isModerator();

      // Authenticated users can create comments
      allow create: if isAuthenticated();

      // Users can edit their own comments
      // Moderators can edit any comment
      allow update: if isAuthenticated() && (
        resource.data.authorId == request.auth.uid
        || isModerator()
      );

      // Users can delete their own comments
      // Moderators can delete any comment
      allow delete: if isAuthenticated() && (
        resource.data.authorId == request.auth.uid
        || isModerator()
      );
    }

    // ============================================
    // TENANTS (SaaS Multi-Tenancy)
    // ============================================
    match /tenants/{tenantId} {
      // Tenant owners and admins can read their tenant
      allow read: if canAccessTenant(tenantId);

      // Only platform admins can create tenants
      // (In production, this would be via API with proper validation)
      allow create: if isAuthenticated();

      // Tenant owners can update their own tenant settings
      // Platform admins can update any tenant
      allow update: if isTenantOwner(tenantId) || isAdmin();

      // Only platform admins can delete tenants
      allow delete: if isAdmin();
    }

    // ============================================
    // CREDIT TRANSACTIONS
    // ============================================
    match /creditTransactions/{transactionId} {
      // Users can read their tenant's transactions
      allow read: if isAuthenticated() && canAccessTenant(resource.data.tenantId);

      // Only server-side operations should create transactions
      // This is typically done via Firebase Admin SDK
      // For client-side, only platform admins can create
      allow create: if isAdmin();

      // Transactions should be immutable (no updates)
      allow update: if false;

      // Only platform admins can delete (for cleanup)
      allow delete: if isAdmin();
    }

    // ============================================
    // ADVERTISERS
    // ============================================
    match /advertisers/{advertiserId} {
      // Tenant members can read their advertisers
      allow read: if isAuthenticated() && canAccessTenant(resource.data.tenantId);

      // Tenant owners and editors can create advertisers
      allow create: if isAuthenticated() &&
        canAccessTenant(request.resource.data.tenantId) &&
        isTenantActive(request.resource.data.tenantId);

      // Tenant owners and editors can update advertisers
      allow update: if isAuthenticated() &&
        canAccessTenant(resource.data.tenantId) &&
        isTenantActive(resource.data.tenantId);

      // Tenant owners can delete advertisers
      allow delete: if isTenantOwner(resource.data.tenantId) || isAdmin();
    }

    // ============================================
    // ADS (Advertisements)
    // ============================================
    match /tenantAds/{adId} {
      // Anyone can read active ads (they're displayed publicly)
      allow read: if resource.data.status == 'active' ||
        (isAuthenticated() && canAccessTenant(resource.data.tenantId));

      // Tenant members can create ads (if tenant is active)
      allow create: if isAuthenticated() &&
        canAccessTenant(request.resource.data.tenantId) &&
        isTenantActive(request.resource.data.tenantId);

      // Tenant members can update their ads
      allow update: if isAuthenticated() &&
        canAccessTenant(resource.data.tenantId);

      // Tenant owners can delete ads
      allow delete: if isTenantOwner(resource.data.tenantId) || isAdmin();
    }

    // ============================================
    // CATEGORIES (with tenant support)
    // ============================================
    match /categories/{categoryId} {
      // Anyone can read categories
      allow read: if true;

      // Editors and above can manage categories
      allow write: if isEditor();
    }

    // ============================================
    // AI JOURNALISTS (with tenant support)
    // ============================================
    match /aiJournalists/{journalistId} {
      // Tenant members can read their AI journalists
      // For non-tenant mode, editors can read
      allow read: if isEditor() ||
        (isAuthenticated() && resource.data.tenantId != null && canAccessTenant(resource.data.tenantId));

      // Editors can create/update AI journalists
      allow create, update: if isEditor();

      // Only admins can delete
      allow delete: if isAdmin();
    }

    // ============================================
    // CONTENT SOURCES
    // ============================================
    match /contentSources/{sourceId} {
      // Editors can read/write content sources
      allow read, write: if isEditor();
    }

    // ============================================
    // CONTENT ITEMS
    // ============================================
    match /contentItems/{itemId} {
      // Editors can read/write content items
      allow read, write: if isEditor();
    }

    // ============================================
    // SCHEDULED TASKS
    // ============================================
    match /scheduledTasks/{taskId} {
      // Editors can read scheduled tasks
      allow read: if isEditor();

      // Only server-side operations should manage tasks
      allow write: if isAdmin();
    }
  }
}
